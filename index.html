<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“˜ Registro Medie</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 20px;
      color: #111;
    }
    h1 { text-align: center; margin-bottom: 20px; }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .subjects {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }
    .subject-btn {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      text-align: center;
      cursor: pointer;
      background: #f9fafb;
    }
    .subject-btn.active {
      background: #6366f1;
      color: white;
      border-color: #4f46e5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 8px;
      text-align: center;
      vertical-align: top;
    }
    input[type="number"] {
      width: 70px;
      padding: 4px;
      margin: 3px 0;
      text-align: center;
    }
    .vote {
      font-weight: bold;
      padding: 3px 6px;
      border-radius: 6px;
      display: inline-block;
      margin: 2px;
    }
    .red { background: #fecaca; color: #b91c1c; }
    .orange { background: #fed7aa; color: #c2410c; }
    .green { background: #bbf7d0; color: #166534; }
    .note {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      margin: 5px;
      font-size: 14px;
      color: white;
    }
    .disciplinare { background: #ef4444; }
    .didattica { background: #3b82f6; }
    .note button {
      margin-left: 6px;
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
    }
    .condotta {
      font-size: 24px;
      font-weight: bold;
      color: #111;
    }
    .add-btn {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>ðŸ“˜ Registro Medie</h1>

  <!-- Materie -->
  <div class="card">
    <h2>Materie</h2>
    <div class="subjects" id="subjects"></div>
  </div>

  <!-- Voti -->
  <div class="card">
    <h2>Voti</h2>
    <table id="gradesTable">
      <thead>
        <tr>
          <th>Materia</th>
          <th>1Â° Quad.</th>
          <th>2Â° Quad.</th>
          <th>Media</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Note -->
  <div class="card">
    <h2>Note</h2>
    <input type="text" id="noteText" placeholder="Scrivi una nota">
    <select id="noteType">
      <option value="disciplinare">Disciplinare</option>
      <option value="didattica">Didattica</option>
    </select>
    <button onclick="addNote()">Aggiungi</button>
    <div id="notes"></div>
  </div>

  <!-- Riepilogo -->
  <div class="card">
    <h2>Riepilogo</h2>
    <p class="condotta">Condotta: <span id="conduct">10</span></p>
    <p>Media 1Â° Quadrimestre: <span id="avg1">-</span></p>
    <p>Media 2Â° Quadrimestre: <span id="avg2">-</span></p>
    <p>Media generale: <span id="avgTotal">-</span></p>
  </div>

  <script>
    const SUBJECTS = [
      "Italiano","Storia","Geografia","Matematica","Scienze","Inglese","Francese","Spagnolo","Tedesco","Arte","Musica","Tecnologia","Scienze Motorie","Religione"
    ];

    let state = JSON.parse(localStorage.getItem("registro_voti")) || {
      subjects: [],
      grades: {}, // { Materia: { q1: [voti], q2: [voti] } }
      notes: []
    };

    const subjectsDiv = document.getElementById("subjects");
    const tableBody = document.querySelector("#gradesTable tbody");
    const notesDiv = document.getElementById("notes");

    function save() {
      localStorage.setItem("registro_voti", JSON.stringify(state));
      render();
    }

    function toggleSubject(s) {
      if (state.subjects.includes(s)) {
        state.subjects = state.subjects.filter(x => x !== s);
      } else {
        state.subjects.push(s);
        state.grades[s] = { q1: [], q2: [] };
      }
      save();
    }

    function addVote(s, q) {
      const val = prompt("Inserisci voto (anche decimale):");
      if (!val) return;
      const num = parseFloat(val.replace(",", "."));
      if (isNaN(num) || num < 1 || num > 10) return alert("Voto non valido (1-10)");
      state.grades[s][q].push(num);
      save();
    }

    function deleteVote(s, q, idx) {
      state.grades[s][q].splice(idx, 1);
      save();
    }

    function addNote() {
      const text = document.getElementById("noteText").value.trim();
      const type = document.getElementById("noteType").value;
      if (!text) return;
      state.notes.push({ id: Date.now(), text, type });
      document.getElementById("noteText").value = "";
      save();
    }

    function deleteNote(id) {
      state.notes = state.notes.filter(n => n.id !== id);
      save();
    }

    function conduct() {
      let base = 10;
      const discNotes = state.notes.filter(n => n.type === "disciplinare").length;
      base -= discNotes * 0.5;
      return Math.max(1, base.toFixed(2));
    }

    function getColor(v) {
      if (v < 6) return "red";
      if (v < 7) return "orange";
      return "green";
    }

    function avg(arr) {
      return arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2) : "-";
    }

    function render() {
      // materie
      subjectsDiv.innerHTML = "";
      SUBJECTS.forEach(s => {
        const btn = document.createElement("div");
        btn.className = "subject-btn" + (state.subjects.includes(s) ? " active" : "");
        btn.innerText = s;
        btn.onclick = () => toggleSubject(s);
        subjectsDiv.appendChild(btn);
      });

      // voti
      tableBody.innerHTML = "";
      state.subjects.forEach(s => {
        const g = state.grades[s] || { q1: [], q2: [] };
        const m1 = avg(g.q1);
        const m2 = avg(g.q2);
        const media = (m1 !== "-" && m2 !== "-") ? ((+m1 + +m2)/2).toFixed(2) : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s}</td>
          <td>
            ${g.q1.map((v,i)=>`<span class="vote ${getColor(v)}">${v}<sup onclick="deleteVote('${s}','q1',${i})" style="cursor:pointer;color:#333">âœ•</sup></span>`).join("")}
            <br><button class="add-btn" onclick="addVote('${s}','q1')">+ Voto</button>
            <br><b>Media: ${m1}</b>
          </td>
          <td>
            ${g.q2.map((v,i)=>`<span class="vote ${getColor(v)}">${v}<sup onclick="deleteVote('${s}','q2',${i})" style="cursor:pointer;color:#333">âœ•</sup></span>`).join("")}
            <br><button class="add-btn" onclick="addVote('${s}','q2')">+ Voto</button>
            <br><b>Media: ${m2}</b>
          </td>
          <td>${media !== "-" ? `<span class="vote ${getColor(+media)}">${media}</span>` : "-"}</td>
        `;
        tableBody.appendChild(tr);
      });

      // note
      notesDiv.innerHTML = "";
      state.notes.forEach(n => {
        const span = document.createElement("span");
        span.className = "note " + n.type;
        span.innerHTML = `${n.text} <button onclick="deleteNote(${n.id})">âœ•</button>`;
        notesDiv.appendChild(span);
      });

      // riepilogo
      document.getElementById("conduct").innerText = conduct();

      const allQ1 = state.subjects.flatMap(s => state.grades[s].q1);
      const allQ2 = state.subjects.flatMap(s => state.grades[s].q2);

      const avg1 = avg(allQ1);
      const avg2 = avg(allQ2);

      document.getElementById("avg1").innerText = avg1;
      document.getElementById("avg2").innerText = avg2;

      if (avg1 !== "-" && avg2 !== "-") {
        document.getElementById("avgTotal").innerText = ((+avg1 + +avg2)/2).toFixed(2);
      } else {
        document.getElementById("avgTotal").innerText = "-";
      }
    }

    render();
  </script>
</body>
</html>
